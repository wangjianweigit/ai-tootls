# Excel半结构化数据解析工具 - 最佳实践指南

## 📋 概述

本指南通过一个包含50条医疗病例记录的实际案例，展示如何使用Excel半结构化数据解析工具高效地从非结构化文本中提取结构化信息。

## 🎯 应用场景

本示例模拟了医疗信息系统中常见的场景：
- **数据来源**：病历系统导出的文本记录
- **数据特点**：半结构化，包含大量自然语言描述
- **业务需求**：需要提取关键字段用于统计分析、数据报表、科研分析等

## 📊 示例数据说明

### 数据文件
- **文件名称**：`best_practice_sample_50.xlsx`
- **文件位置**：`excel_parser_data/imports/best_practice_sample_50.xlsx`
- **记录数量**：50条
- **数据复杂度**：中高级

### 数据结构
每条记录包含：
- **病例编号**：唯一标识符（如：BL20240001）
- **病例记录**：包含以下信息的半结构化文本
  - 患者基本信息（姓名、性别、年龄）
  - 就诊时间
  - 主诉症状
  - 既往病史
  - 体格检查数据（体温、血压、心率）
  - 处方用药

### 数据示例

```
患者张明华，男性，65岁，于2024年03月15日来院就诊。
主诉：头痛、发热、乏力已5天。
既往史：高血压、糖尿病。
体格检查：体温38.5℃，血压150/95mmHg，心率88次/分。
初步诊断：待查。建议完善相关检查。
处方用药：对乙酰氨基酚、阿司匹林、美托洛尔等，按医嘱服用。
医嘱：注意休息，清淡饮食，避免劳累，定期复查。
```

## 🔧 解析任务设计

### 任务目标
将半结构化的病例记录转换为结构化数据表，便于后续的数据分析和统计。

### 目标字段设计

| 字段名称 | 数据类型 | 说明 | 示例 |
|---------|---------|------|------|
| 患者姓名 | 文本 | 患者的真实姓名 | 张明华 |
| 性别 | 文本 | 男/女 | 男 |
| 年龄 | 数值 | 患者年龄 | 65 |
| 就诊日期 | 日期文本 | 就诊时间 | 2024年03月15日 |
| 主诉症状 | 文本 | 主要症状列表 | 头痛、发热、乏力 |
| 症状持续天数 | 数值 | 症状持续时间 | 5 |
| 既往病史 | 文本 | 既往疾病史 | 高血压、糖尿病 |
| 体温 | 数值 | 体温（℃） | 38.5 |
| 收缩压 | 数值 | 收缩压（mmHg） | 150 |
| 舒张压 | 数值 | 舒张压（mmHg） | 95 |
| 心率 | 数值 | 心率（次/分） | 88 |
| 处方用药 | 文本 | 药物列表 | 对乙酰氨基酚、阿司匹林、美托洛尔 |

## 📝 操作步骤详解

### 第一步：上传文件

1. 访问工具首页：`http://localhost:5001/excel-tools/`
2. 点击"选择文件"按钮，选择 `best_practice_sample_50.xlsx`
3. **索引列配置**：选择"病例编号"作为索引列
   - ✅ **推荐**：使用唯一标识列作为索引，便于后续数据关联
   - ⚠️ **注意**：索引列的值必须唯一
4. 点击"上传并解析"

### 第二步：配置解析规则

> 💡 **提示**：规则配置是整个数据解析过程的核心，配置质量直接决定提取准确率。建议仔细阅读本节内容。

#### 📋 规则配置三要素

每个解析规则包含三个必填项：

```
┌─────────────────────────────────────────────────┐
│ 1️⃣ 源列      - 包含原始数据的列名               │
│ 2️⃣ 目标列    - 要提取的字段名（用逗号分隔）      │
│ 3️⃣ 解析提示词 - 告诉AI如何提取数据              │
└─────────────────────────────────────────────────┘
```

**配置界面说明**：
- **源列下拉框**：选择包含半结构化文本的列（如：病例记录）
- **目标列输入框**：填写要提取的字段名，用逗号分隔（如：患者姓名, 性别, 年龄）
- **解析提示词文本框**：详细说明如何从源列中提取目标列的数据

#### 🎯 配置方案选择

根据你的需求和经验，可以选择不同的配置方案：

**方案A：简化版（推荐新手）**
- 配置1-2个规则
- 只提取最重要的字段
- 快速验证工具效果

**方案B：标准版（推荐使用）**
- 配置2-3个规则
- 按数据类型分组提取
- 平衡效率和完整性

**方案C：完整版（高级用户）**
- 配置5个规则
- 全面提取所有字段
- 最大化数据价值

---

#### 规则1：提取患者基本信息

**配置参数：**
- **源列**：病例记录
- **目标列**：`患者姓名, 性别, 年龄, 就诊日期`
- **解析提示词**：
```
请从病例记录中提取以下基本信息：
1. 患者姓名：患者的完整姓名（通常在"患者"二字后面）
2. 性别：男性或女性，统一输出为"男"或"女"
3. 年龄：患者的年龄数字，只输出数字，不包含"岁"字
4. 就诊日期：就诊的完整日期，保持原格式（如：2024年03月15日）

注意：
- 年龄必须是纯数字
- 性别只能是"男"或"女"
- 如果找不到某个字段，请输出空字符串
```

#### 规则2：提取症状信息

**配置参数：**
- **源列**：病例记录
- **目标列**：`主诉症状, 症状持续天数`
- **解析提示词**：
```
请从病例记录中提取症状相关信息：
1. 主诉症状：患者的主要症状列表，保留原文的症状描述，多个症状用顿号"、"分隔
2. 症状持续天数：症状已经持续的天数，只输出数字

注意：
- 症状通常在"主诉："后面
- 持续天数通常表述为"已X天"
- 症状持续天数必须是纯数字
```

#### 规则3：提取既往病史

**配置参数：**
- **源列**：病例记录
- **目标列**：`既往病史`
- **解析提示词**：
```
请从病例记录中提取既往病史信息：
- 既往病史：患者的既往疾病史，多个疾病用顿号"、"分隔

注意：
- 既往病史通常在"既往史："后面
- 如果记录为"无"或"无特殊"，请输出"无"
- 保持原文的疾病名称
```

#### 规则4：提取体格检查数据

**配置参数：**
- **源列**：病例记录
- **目标列**：`体温, 收缩压, 舒张压, 心率`
- **解析提示词**：
```
请从病例记录中提取体格检查的生理指标数据：
1. 体温：体温数值（℃），只输出数字，保留一位小数
2. 收缩压：血压的高压值（mmHg），只输出数字
3. 舒张压：血压的低压值（mmHg），只输出数字
4. 心率：心率数值（次/分），只输出数字

注意：
- 体格检查数据通常在"体格检查："后面
- 血压格式通常为"XXX/XXX mmHg"，前者是收缩压，后者是舒张压
- 所有数值必须是纯数字（体温可以有小数点）
```

#### 规则5：提取处方用药

**配置参数：**
- **源列**：病例记录
- **目标列**：`处方用药`
- **解析提示词**：
```
请从病例记录中提取处方用药信息：
- 处方用药：医生开具的药物列表，多个药物用顿号"、"分隔

注意：
- 处方用药通常在"处方用药："后面
- 提取所有药物名称，去除"等"、"按医嘱服用"等非药物文字
- 保持原文的药物名称
```

### 第三步：设置处理参数

#### 线程数设置
- **推荐配置**：
  - 小数据集（<100条）：1-2个线程
  - 中等数据集（100-500条）：2-4个线程
  - 大数据集（>500条）：4-8个线程

- **本示例推荐**：2个线程
  - 数据量适中（50条）
  - 平衡速度和稳定性

#### 检查点间隔
- **推荐配置**：每50条记录保存一次
- **作用**：
  - ✅ 防止任务中断导致数据丢失
  - ✅ 支持断点续传
  - ✅ 及时查看处理进度

- **本示例推荐**：50
  - 正好覆盖全部数据
  - 处理完成后自动保存

### 第四步：启动任务

1. 检查所有规则配置是否正确
2. 点击"开始处理任务"按钮
3. 系统自动启动后台处理任务
4. 可以在"任务管理"区域查看实时进度

### 第五步：监控与管理

#### 监控任务进度
- **实时进度**：显示已处理记录数/总记录数
- **状态标识**：
  - 🟡 等待中（pending）
  - 🔵 处理中（processing）
  - 🟢 已完成（completed）
  - 🔴 失败（failed）

#### 任务管理操作
- **刷新**：手动刷新任务状态
- **重启**：从断点恢复失败的任务
- **下载**：下载处理完成的结果文件

### 第六步：下载结果

1. 等待任务状态变为"已完成"
2. 点击"下载结果"按钮
3. 获得处理后的Excel文件，包含所有提取的结构化数据

---

## 📚 规则配置深度指南

### 一、目标列配置详解

#### 格式要求

目标列需要用逗号分隔，支持中文逗号（，）和英文逗号（,）：

```
✅ 正确格式：
患者姓名, 性别, 年龄, 就诊日期
患者姓名，性别，年龄，就诊日期

❌ 错误格式：
患者姓名 性别 年龄        （缺少分隔符）
患者姓名;性别;年龄        （错误的分隔符）
```

#### 命名规范

- ✅ 使用简洁明确的中文名称
- ✅ 避免使用特殊字符（除逗号外）
- ✅ 字段名可以包含空格
- ✅ 建议与业务术语保持一致

**示例**：
```
患者姓名, 性别, 年龄        ✅ 清晰易懂
name, gender, age          ✅ 英文也可以
患者/姓名, 性别@性, 年龄#   ❌ 避免特殊字符
```

---

### 二、提示词编写完全指南

#### 优秀提示词的5个要素

```
1️⃣ 明确说明要提取什么
2️⃣ 告诉AI在哪里找这些信息
3️⃣ 规定输出格式（纯数字/带单位/特定格式）
4️⃣ 说明数据缺失时如何处理
5️⃣ 提供示例或注意事项
```

#### 提示词模板

**基础模板**：
```
请从[源列名]中提取以下信息：

1. [字段1名称]：[详细说明]（[位置提示]）
2. [字段2名称]：[详细说明]（[位置提示]）
3. [字段3名称]：[详细说明]（[位置提示]）

注意：
- [格式要求1]
- [格式要求2]
- 如果找不到某个字段，请输出空字符串
```

**完整示例**：
```
请从病例记录中提取患者基本信息：

1. 患者姓名：患者的完整姓名（通常在"患者"二字后面）
2. 性别：男性或女性，统一输出为"男"或"女"
3. 年龄：患者的年龄数字，只输出数字，不包含"岁"字
4. 就诊日期：就诊的完整日期，保持原格式（如：2024年03月15日）

注意：
- 年龄必须是纯数字
- 性别只能是"男"或"女"
- 日期保持原文格式，不要转换
- 如果找不到某个字段，请输出空字符串
```

#### 不同数据类型的提示词技巧

##### 📊 数值型字段

**模板**：
```
[字段名]：[说明]，只输出数字，[精度要求]
- 通常在"[关键词]"后面
- 格式为"[示例格式]"
- 有效范围：[最小值]-[最大值]
```

**示例**：
```
体温：体温数值（℃），只输出数字，保留一位小数
- 通常在"体格检查："后面
- 格式为"体温XX.X℃"
- 有效范围：35.0-42.0
```

##### 📝 文本型字段

**模板**：
```
[字段名]：[说明]，保留原文描述
- 通常在"[关键词]"后面
- 多个[内容]用顿号"、"分隔
- 去除[无用词]
```

**示例**：
```
主诉症状：患者的主要症状列表，保留原文描述
- 通常在"主诉："后面
- 多个症状用顿号"、"分隔
- 去除"已"、"天"等描述性词语
```

##### 📅 日期型字段

**模板**：
```
[字段名]：[说明]，保持原格式
- 通常在"[关键词]"后面
- 不要改变日期格式
- 示例格式：[格式示例]
```

**示例**：
```
就诊日期：就诊的完整日期，保持原格式
- 通常在"于"字后面，"来院就诊"前面
- 不要改变日期格式
- 示例：2024年03月15日
```

##### ✅ 枚举型字段

**模板**：
```
[字段名]：[说明]，只能输出[选项列表]
- 根据[判断依据]进行判断
- 统一输出为"[标准格式]"
```

**示例**：
```
性别：患者性别，只能输出"男"或"女"
- 根据"男性"、"女性"等词判断
- 统一输出为"男"或"女"，不要输出"男性"、"女性"
```

#### 提示词优化对比

**❌ 不好的提示词**：
```
提取患者信息
```
**问题**：太简单，AI不知道提取什么、怎么提取

---

**✅ 好的提示词**：
```
请从病例记录中提取以下患者基本信息：
1. 患者姓名：完整姓名（在"患者"二字后面）
2. 性别：只输出"男"或"女"
3. 年龄：纯数字，不包含"岁"字

注意：如果找不到某个字段，请输出空字符串
```
**优点**：明确、具体、有格式要求、有异常处理

---

### 三、规则配置实战技巧

#### 技巧1：按数据类型分组

将相同类型的字段放在一个规则中：

```
规则1：基本信息（文本+枚举）
  - 姓名、性别、年龄、日期

规则2：数值数据（数值）
  - 体温、血压、心率

规则3：描述信息（文本）
  - 症状、病史、用药
```

**好处**：
- 提示词更专注
- 提取准确率更高
- 便于调试优化

#### 技巧2：从简单到复杂

第一次配置建议：

```
第1步：只配1个规则，提取3-4个简单字段
      ↓
第2步：验证结果，优化提示词
      ↓
第3步：增加更多字段或规则
      ↓
第4步：逐步完善到完整方案
```

#### 技巧3：使用位置关键词

明确告诉AI数据的位置：

```
✅ 好的位置提示：
"通常在'患者'二字后面"
"在'主诉：'后面，'已'字前面"
"体格检查部分，格式为'体温XX.X℃'"

❌ 模糊的提示：
"从文本中提取"
"在病例中找"
```

#### 技巧4：明确输出格式

```
✅ 明确的格式要求：
"只输出数字，保留一位小数"
"只能是'男'或'女'"
"保持原格式，如：2024年03月15日"

❌ 模糊的要求：
"提取年龄"
"提取性别"
```

#### 技巧5：处理边界情况

在提示词中说明特殊情况的处理：

```
如果找不到某个字段，请输出空字符串
如果记录为"无"或"无特殊"，请输出"无"
如果有多个值，用顿号"、"分隔
```

---

### 四、规则配置检查清单

保存规则前，请逐项检查：

#### 基础检查
- [ ] 源列选择正确（包含原始文本的列）
- [ ] 目标列用逗号正确分隔
- [ ] 目标列数量与提示词中的字段数量一致
- [ ] 提示词没有明显的语法错误

#### 内容检查
- [ ] 提示词明确说明了每个字段的提取方法
- [ ] 提示词包含位置提示（在哪里找）
- [ ] 提示词规定了输出格式
- [ ] 提示词说明了数据缺失时的处理方式

#### 质量检查
- [ ] 提示词包含了必要的注意事项
- [ ] 对于数值字段，指定了精度要求
- [ ] 对于枚举字段，列出了可选值
- [ ] 对于文本字段，说明了分隔符

---

### 五、常见问题及解决方案

#### Q1: 提取的数字包含单位怎么办？

**问题**：期望输出"38.5"，实际输出"38.5℃"

**解决**：
```
提示词中明确要求：
"只输出数字，不包含单位符号"
"体温：只输出数字，保留一位小数，不要包含℃符号"
```

#### Q2: 日期格式不统一怎么办？

**问题**：原文是"2024年3月15日"，输出变成"2024-03-15"

**解决**：
```
提示词中强调：
"保持原格式，不要转换日期格式"
"示例：如果原文是'2024年3月15日'，就输出'2024年3月15日'"
```

#### Q3: 找不到数据时输出什么？

**问题**：有些记录缺少某些字段

**解决**：
```
提示词中说明：
"如果找不到某个字段，请输出空字符串"
或者："如果找不到，请输出'未记录'"
```

#### Q4: 如何提取多个相似的值？

**问题**：一个字段可能有多个值，如多个症状

**解决**：
```
提示词中说明分隔方式：
"多个症状用顿号'、'分隔"
"示例：头痛、发热、咳嗽"
```

#### Q5: 规则太多会影响速度吗？

**答案**：会的！建议：
- 新手：1-2个规则
- 标准：2-3个规则
- 高级：3-5个规则

**原因**：
- 规则多会增加API调用次数
- 合理分组可以提高效率
- 过多规则可能导致冲突

---

### 六、提示词优化迭代流程

```
┌─────────────────────────────────────────┐
│ 1️⃣ 编写初版提示词                        │
│    - 基于模板快速编写                     │
│    - 包含基本要素                         │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ 2️⃣ 小批量测试（5-10条）                  │
│    - 检查提取结果                         │
│    - 记录问题字段                         │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ 3️⃣ 分析问题并优化                        │
│    - 格式不对？→ 明确格式要求             │
│    - 找不到？→ 优化位置提示               │
│    - 多余内容？→ 增加过滤规则             │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ 4️⃣ 再次测试验证                          │
│    - 准确率>95%？→ 进入下一步             │
│    - 还有问题？→ 返回步骤3                │
└─────────────────┬───────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│ 5️⃣ 批量处理全部数据                      │
│    - 监控任务进度                         │
│    - 完成后验证质量                       │
└─────────────────────────────────────────┘
```

---

## 💡 最佳实践技巧

### 1. 提示词编写技巧

#### ✅ 好的提示词特征
- **明确具体**：清楚说明要提取什么信息
- **格式规范**：明确输出格式要求
- **异常处理**：说明找不到信息时如何处理
- **示例说明**：提供数据示例帮助AI理解

#### ❌ 避免的问题
- 提示词过于简单：只说"提取姓名"而不说明在哪里找
- 格式不明确：没有说明是否包含单位、标点符号等
- 缺少边界情况处理：没有说明数据缺失时的处理方式

#### 示例对比

**不好的提示词：**
```
提取患者信息
```

**好的提示词：**
```
请从病例记录中提取以下信息：
1. 患者姓名：完整姓名，通常在"患者"二字后面
2. 性别：只输出"男"或"女"
3. 年龄：纯数字，不包含"岁"字
如果某个字段找不到，请输出空字符串。
```

### 2. 规则拆分策略

#### 为什么要拆分规则？
- ✅ 提高准确性：每个规则专注于特定类型的数据
- ✅ 便于调试：单独测试和优化每个规则
- ✅ 灵活扩展：可以随时添加新的提取字段
- ✅ 并行处理：多个规则可以并行执行，提高效率

#### 拆分原则
1. **按数据类型分组**：基本信息、症状信息、检查数据等
2. **按复杂度分离**：简单提取和复杂推理分开
3. **按依赖关系组织**：独立数据优先，派生数据其次

### 3. 索引列选择

#### 何时使用索引列？
- ✅ 数据有唯一标识符（如：病例编号、学号、订单号）
- ✅ 需要与其他数据源关联
- ✅ 需要追溯原始记录

#### 何时使用行号？
- ⚠️ 数据没有唯一标识符
- ⚠️ 只是一次性分析，不需要关联

#### 本示例的选择
选择"病例编号"作为索引列，因为：
- 具有唯一性
- 便于追溯和关联
- 符合实际业务场景

### 4. 线程数优化

#### 性能测试建议
1. **从少到多**：先用1个线程测试，确保规则正确
2. **逐步增加**：2 → 4 → 8，观察性能变化
3. **找到平衡点**：速度提升不明显时即为最优值

#### 影响因素
- **API限流**：大模型API可能有调用频率限制
- **系统资源**：CPU、内存、网络带宽
- **数据复杂度**：复杂数据需要更多处理时间

#### 经验值参考
| 数据量 | 推荐线程数 | 预计耗时（每条3-5秒） |
|--------|-----------|---------------------|
| <50条  | 1-2       | 3-5分钟             |
| 50-100条 | 2-3     | 5-10分钟            |
| 100-500条 | 3-5    | 10-40分钟           |
| >500条 | 5-8       | 40分钟以上          |

### 5. 检查点策略

#### 检查点间隔设置
- **小间隔**（10-20）：
  - ✅ 数据保护更频繁
  - ❌ 磁盘IO开销增加
  - 适合：不稳定网络环境

- **中等间隔**（50-100）：
  - ✅ 平衡性能和安全
  - ✅ **推荐用于大多数场景**
  - 适合：常规业务数据处理

- **大间隔**（>100）：
  - ✅ 减少IO开销
  - ❌ 中断时损失较多
  - 适合：稳定环境+大数据量

### 6. 错误处理与重试

#### 常见错误类型
1. **API错误**
   - 原因：网络问题、API限流、配额不足
   - 处理：使用断点续传，重启任务

2. **格式错误**
   - 原因：AI输出格式不符合预期
   - 处理：优化提示词，明确格式要求

3. **数据缺失**
   - 原因：原始数据不完整
   - 处理：在提示词中说明缺失值处理方式

#### 重启任务的最佳时机
- ✅ 任务失败后立即重启
- ✅ 网络恢复后重启
- ✅ 调整参数后重启
- ❌ 不要在处理中强制重启

### 7. 数据质量检查

#### 处理完成后的验证步骤
1. **完整性检查**
   - 确认处理记录数 = 原始记录数
   - 检查是否有空值或缺失值

2. **格式验证**
   - 数值字段：确认是纯数字
   - 日期字段：确认格式一致
   - 文本字段：检查是否有异常字符

3. **逻辑验证**
   - 年龄范围是否合理
   - 体温、血压等生理指标是否在正常范围
   - 性别是否只有"男"或"女"

4. **抽样核对**
   - 随机抽取5-10条记录
   - 对比原文和提取结果
   - 确认准确率

## 🎓 进阶应用

### 场景1：多轮优化
1. 第一轮：快速提取基本字段（线程数=1）
2. 分析结果，识别问题字段
3. 第二轮：优化提示词，重新处理（线程数=2-4）
4. 迭代优化直到满意

### 场景2：批量处理多个文件
1. 保存最佳配置的规则模板
2. 对多个类似文件重复应用相同规则
3. 使用API接口实现自动化批处理

### 场景3：复杂推理任务
对于需要推理的字段（如：疾病风险评估、用药冲突检测），可以：
1. 先提取基础数据
2. 基于提取的结构化数据，设计第二轮推理规则
3. 多次处理，逐步深化分析

### 场景4：数据清洗与标准化
1. 第一步：提取原始数据
2. 第二步：使用AI进行数据清洗
   - 统一单位
   - 标准化术语
   - 纠正错别字
3. 第三步：数据验证与质量报告

## 📊 性能优化建议

### 提升处理速度
1. **合理使用多线程**：根据API限制和系统资源调整
2. **批量处理**：尽量在一个规则中处理多个相关字段
3. **减少规则数量**：合并相似的提取任务
4. **优化提示词长度**：简洁明确，避免冗余

### 降低成本
1. **精简提示词**：减少token消耗
2. **合并规则**：减少API调用次数
3. **测试先行**：用小数据集测试规则，确认无误后再处理大数据
4. **选择合适的模型**：根据任务复杂度选择性价比最优的模型

## ⚠️ 注意事项

### 数据安全
- 🔒 敏感数据（如真实病历）建议脱敏后再处理
- 🔒 处理完成后及时删除临时文件
- 🔒 遵守数据保护相关法律法规

### API使用
- ⚡ 注意API调用限制和配额
- ⚡ 合理设置重试间隔，避免被限流
- ⚡ 监控API使用量和成本

### 结果验证
- ✓ 不要100%依赖AI提取结果
- ✓ 关键数据必须人工抽检验证
- ✓ 建立质量评估机制

## 📈 预期效果

使用本最佳实践配置，处理50条示例数据的预期效果：

| 指标 | 预期值 |
|------|--------|
| 处理时间 | 5-8分钟（2线程） |
| 准确率 | >95% |
| 完整率 | >98% |
| 格式一致性 | >99% |

## 🎯 总结

通过本最佳实践，你应该掌握：

1. ✅ 如何设计合理的字段提取方案
2. ✅ 如何编写高质量的提示词
3. ✅ 如何配置最优的处理参数
4. ✅ 如何监控和管理处理任务
5. ✅ 如何验证和优化处理结果

## 📞 技术支持

如有问题，请参考：
- 工具文档：`README.md`
- 集成指南：`INTEGRATION_GUIDE.md`
- 任务管理：访问 `/excel-tools/tasks` 查看所有任务

---

**最后更新时间**：2024年10月15日

